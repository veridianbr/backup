{"createdAt":"2025-06-13T17:31:06.195Z","updatedAt":"2025-06-13T19:01:26.739Z","id":"EPdZOmq773KMI1vZ","name":"MAIN","active":false,"isArchived":false,"nodes":[{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[4940,480],"id":"6562daaf-02fa-4aab-8bfe-96f980b8b317","name":"Loop Over Items"},{"parameters":{"amount":1},"id":"92bb1288-dce3-4be3-9bf5-e379c2c59e3d","name":"Wait1","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[5260,500],"webhookId":"de0c5c75-3868-4fbe-a2a1-5c765ecbb418"},{"parameters":{"fieldToSplitOut":"mensagens","options":{}},"id":"11a3d201-a6a0-4a65-9ed3-bb4dc0b8c410","name":"Split Out1","type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[4640,480]},{"parameters":{"assignments":{"assignments":[{"id":"2f56ff24-5f31-403b-876a-77aa7aaee05b","name":"main.lead.remoteJid","value":"={{ $json.body.data.key.remoteJid }}","type":"string"},{"id":"f654d089-6dfc-42fa-869e-caee66c917d2","name":"main.interno.fromMe","value":"={{ $json.body.data.key.fromMe }}","type":"boolean"},{"id":"70d13441-e98f-4922-8ac0-5748ae769254","name":"main.lead.pushName","value":"={{ $json.body.data.pushName }}","type":"string"},{"id":"859c45b4-f866-4adb-868e-aa489c4a6b79","name":"main.lead.content","value":"={{ $json.body?.data?.message?.extendedTextMessage?.text || '' }}{{ $json.body?.data?.message?.imageMessage?.caption || '' }}{{ $json.body?.data?.message?.conversation || '' }}{{ $json.body?.data?.message?.reactionMessage?.text || '' }}{{ $json?.body?.data?.message?.templateMessage?.hydratedTemplate?.hydratedContentText || ''}}{{ $json?.body?.data?.message?.speechToText || '' }}","type":"string"},{"id":"85b9bce5-f132-489a-8300-902307f4d8d1","name":"main.interno.messageType","value":"={{ $json.body?.data?.message?.extendedTextMessage ? 'text' : '' }}{{ $json.body?.data?.messageType === 'conversation' ? 'text' : '' }}{{ $json.body?.data?.message?.audioMessage ? 'audio' : '' }}{{ $json.body?.data?.message?.imageMessage ? 'image' : '' }}{{ $json.body?.data?.messageType === 'reactionMessage' ? 'text' : '' }}{{ $json.body?.data?.messageType === 'templateMessage' ? 'text' : ''}}{{ $json.body.data.messageType === 'stickerMessage' ? 'image' : '' }}","type":"string"},{"id":"75a99105-aa64-4046-86d9-5ba1f1ed9983","name":"main.interno.serverUrl","value":"={{ $json.body.server_url }}","type":"string"},{"id":"fc4e8522-765f-4c1c-ab6b-a080918d80c2","name":"main.interno.apiKey","value":"={{ $json.body.apikey }}","type":"string"},{"id":"8ba90841-6a52-492c-8c78-837fdd0ef763","name":"main.interno.instance","value":"={{ $json.body.instance }}","type":"string"},{"id":"bb2f01d3-bebe-4eca-92b3-3bb18d45b4cd","name":"main.interno.mediaUrl","value":"={{ $json.body.data.message.mediaUrl }}","type":"string"},{"id":"ff6c9a08-53ed-4b84-a6e0-9e7e1c8a965c","name":"main.interno.messageId","value":"={{ $json.body.data.key.id }}","type":"string"},{"id":"211712fc-09bf-46c6-8d69-eba8584db143","name":"main.interno.timestamp","value":"={{ $json.body.data.messageTimestamp.toDateTime('s').toISO() }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1140,420],"id":"863989fd-251e-49ac-a0a4-1d8f7411e390","name":"normalizacao"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('normalizacao').item.json.main.interno.messageType }}","rightValue":"text","operator":{"type":"string","operation":"equals"},"id":"69f0d7f5-b8aa-4566-92aa-38ce4c6c3029"}],"combinator":"and"},"renameOutput":true,"outputKey":"TEXTO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8b7fce0a-dad9-417c-90b9-c453f9118120","leftValue":"={{ $('normalizacao').item.json.main.interno.messageType }}","rightValue":"audio","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"AUDIO"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[520,560],"id":"b9cb9347-34a8-4f8f-8135-ff8638a82d59","name":"Switch"},{"parameters":{"assignments":{"assignments":[{"id":"a4bed19c-e2a8-46d1-ba71-3a080efc7407","name":"content","value":"={{ $('normalizacao').item.json.main.lead.content }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1180,360],"id":"68d8fbfb-4bd7-4109-af48-2bba41a90312","name":"concat_text"},{"parameters":{"operation":"push","list":"={{ $('crm').item.json.identifier }}_MESSAGE","messageData":"={{ JSON.stringify($json) }}","tail":true},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1860,480],"id":"cd0f79e0-3c54-4ea2-a6ff-bec9e7ea7079","name":"armazena_messagem","credentials":{"redis":{"id":"CmFcWR0TAFesyTem","name":"Veridian Redis account"}}},{"parameters":{"operation":"get","propertyName":"messages","key":"={{ $('crm').item.json.identifier }}_MESSAGE","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2080,480],"id":"09dc9032-af29-4f08-bdcb-2d259ad1bc06","name":"obter_mensages_buffer","credentials":{"redis":{"id":"CmFcWR0TAFesyTem","name":"Veridian Redis account"}}},{"parameters":{"assignments":{"assignments":[{"id":"1f647add-4dbc-475c-ba4c-f416374a743a","name":"chatInput","value":"={{ $json.messages.map(value => JSON.parse(value).main.finaltext).join(\"\\n\") }}","type":"string"},{"id":"4a7c7106-dff5-46c1-994a-9ea7c4dc71d7","name":"main.interno.messageId","value":"={{ $('normalizacao').item.json.main.interno.messageId }}","type":"string"},{"id":"5f25b98e-ce4d-4a4c-8d89-73f961289bfd","name":"main.interno.pushName","value":"={{ $('normalizacao').item.json.main.lead.pushName }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2760,480],"id":"3ed5210d-15c2-4b9b-9ccb-b7b038cf0ff8","name":"concatena_messages"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.messages.first().parseJson().main.data.interno.messageId }}","rightValue":"={{ $('normalizacao').item.json.main.interno.messageId }}","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"NADA A FAZER"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a9eeffab-b065-4d08-a9aa-7584350ac532","leftValue":"={{ $json.messages.last().parseJson().main.data.interno.timestamp }}","rightValue":"={{ $now.minus(5, 'seconds') }}","operator":{"type":"dateTime","operation":"before"}}],"combinator":"and"},"renameOutput":true,"outputKey":"PROSSEGUIR"}]},"options":{"fallbackOutput":"extra","renameFallbackOutput":"ESPERAR"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[2280,480],"id":"71553664-be56-40b3-824c-eab7df30a41f","name":"Switch1"},{"parameters":{"assignments":{"assignments":[{"id":"2e05527b-4d82-43cd-a4e3-373274c3a74f","name":"main.finaltext","value":"={{ $json.content }}","type":"string"},{"id":"40596a72-087e-4396-83be-d39c05cc7847","name":"main.data","value":"={{ $('normalizacao').item.json.main }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1640,500],"id":"81cf8b5a-0863-4cfe-a4cd-350976110c61","name":"concat"},{"parameters":{"amount":1},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[2580,660],"id":"04544bb3-79e8-48b5-ae0d-3a4d48a5a708","name":"Wait2","webhookId":"f16320e4-29dd-44a5-bc1a-bd2014126be8"},{"parameters":{"operation":"delete","key":"={{ $('crm').item.json.identifier }}_MESSAGE"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2560,480],"id":"b2b61ec8-192d-4e5c-a958-a9d5f97024f8","name":"Redis3","credentials":{"redis":{"id":"CmFcWR0TAFesyTem","name":"Veridian Redis account"}}},{"parameters":{"options":{"systemMessage":"={\n  \"context\": {\n    \"identity\": \"Vivian - Assistente de atendimento\",\n    \"business\": \"Veridian - Solu√ß√µes de Automa√ß√£o Inteligentes\",\n    \"Language\": \"portugu√™s brasileiro\",\n    \"date\": \"{{ $now.weekdayLong }}, {{ $now.format('dd/MM/yyyy') }}, {{ $now.hour.toString().padStart(2, '0') }}:{{ $now.minute.toString().padStart(2, '0') }}\"\n  },\n\n  \"personality\": [\n    \"Profissional, Amig√°vel, Emp√°tica, Fala clara e objetiva, use emojis com modera√ß√£o (apenas: üòä, üòÅ e ü•∞)\"\n  ],\n\n  \"objectives\": [\n    \"Qualificar o cliente, entender suas dores, gerar um resumo da situa√ß√£o, envia-lo para o CRM e dizer ao cliente que tem a solu√ß√£o para seu problema\",\n    \"Oferecer e agendar uma reuni√£o obrigatoriamente\"\n  ],\n\n  \"general_rules\": [\n    \"Quando estiver realizando a Descoberta de Necessidades (Anamnese), sempre responda as perguntas do lead antes de prosseguir para o pr√≥xima mensagem\",\n    \"Nunca finalize um primeiro contato sem oferecer agendamento\",\n    \"Foque no objetivo do cen√°rio: atendimento, coleta de informa√ß√µes do cliente e agendamento de reuni√£o\",\n    \"Use a tool 'AGENDAMENTO' para agendar a reuni√£o\",\n    \"Use a tool 'ENVIAR_CRM' para enviar o resumo gerado para o CRM\",\n    \"o nome do cliente √© {{ $('Webhook1').item.json.body.data.pushName }}, caso seja um nome composto, use apenas o primeiro nome.\nExemplo: Gustavo Murilo. Use apenas 'Gustavo', ignore o 'Murilo'\",\n\n  ],\n\n  \"guardrails\": [\n    \"Nunca inicie uma conversa novamente com o cliente ap√≥s finalizar um atendimento\", \n    \"Jamais fale para o cliente sobre os processos internos que est√° realizando, nunca diga que salvou as informa√ß√µes dele no sistema\",\n    \"Sempre cite apenas o primeiro nome do cliente na primeira mensagem {{ $('Webhook1').item.json.body.data.pushName }}, n√£o use o sobrenome\"\n    \"Nunca cite o sobrenome de um cliente, sempre se refira a ele apenas pelo primeiro nome\"\n]\n\n  \"flow\": {\n    \"steps\": [\n      {\n        \"step\": \"Sauda√ß√£o e Apresenta√ß√£o da Veridian\",\n        \"instructions\": \"Apresente-se como Vivian da Veridian\",\n        \"obrigatory_messages\": \"Oiii {{ $('Webhook1').item.json.body.data.pushName }}, tudo bem?üòä/ Aqui √© a Vivian da Veridian. / Fico feliz que voc√™ esteja aqui!/ Oferecemos os melhores assistentes de IA do Brasil, que ajudam seu neg√≥cio a vender mais, aprimoram o suporte aos seus clientes e agendam consultas de forma super eficiente!\n/ Mas, antes de entrar em mais detalhes sobre eles, me conta uma coisa: qual √© o nome do seu neg√≥cio e o que voc√™s fazem?\n\"\n      },\n      {\n        \"step\": \"Descoberta de Necessidades (Anamnese)\",\n        \"instructions\": \"Realize a sequ√™ncia de perguntas abaixo (uma por uma, nunca fa√ßa mais de uma pergunta por vez), de forma natural, esperando a resposta do cliente antes de prosseguir para a pr√≥xima pergunta\",\n        \"obrigatory_messages\": \"Pra gente entender melhor como ajudar, posso te fazer algumas perguntas r√°pidas?\\n Legal, {{ $('Webhook1').item.json.body.data.pushName }}! E em m√©dia quantas mensagens voc√™ recebe por dia no WhatsApp?\\n Voc√™ faz isso sozinha ou tem uma equipe para ajudar?\nQuais s√£o os principais desafios que voc√™ enfrenta no atendimento ao cliente?\\n Voc√™s t√™m algum sistema de CRM ou controle de leads?\\n Como voc√™ classifica o porte do seu neg√≥cio - pequeno, m√©dio ou grande? Isso nos ajuda a personalizar a melhor solu√ß√£o para voc√™.\"\n      },\n      {\n        \"step\": \"Oferecer Agendamento\",\n        \"instructions\": \"Nunca pule esta etapa. Convide para agendar uma conversa via Google Agenda\",\n        \"example_message\": \"Perfeito,(insira o nome do cliente aqui). Obrigada pelas informa√ß√µes ü•∞. / J√° temos o seu diagn√≥stico e o pr√≥ximo passo √© agendarmos uma reuni√£o! Ser√° bem rapidinho e nela eu vou te apresentar a solu√ß√£o ideal pra voc√™ j√° com informa√ß√µes de pre√ßos! Vamos marcar?\"\n      },\n      {\n        \"step\": \"Solicitar email\",\n        \"instructions\": \"Solicite o email do cliente\"\n        \"example_message\": \"Me mande o seu e-mail para que eu possa abrir o pedido de agendamento aqui na Veridian por favor!\"\n      },\n      {\n        \"step\": \"AGENDAMENTO\",\n        \"instructions\": \"OBRIGATORIO. Use sempre a tool AGENDAMENTOS para buscar hor√°rios dispon√≠veis e agendar. Nunca agende mais de uma reuni√£o para o mesmo hor√°rio.\"\n        \"example_message\": \"Econtrei um dia dispon√≠vel, posso agendar para (data e hora dispon√≠veis)?\"\n      },\n      {\n        \"step\": \"Enviar link da reuni√£o para o cliente\",\n        \"instructions\": \"OBRIGATORIO. Diga ao cliente que ele vai receber o link da reuni√£o no email que ele forneceu. \n\nTamb√©m envie o link da reuni√£o pra ele (n√£o use markdowm ou envie todas as informa√ß√µes, envie apenas o link\"\n      },\n\n      {\n        \"step\": \"Enviar RESUMO e LINK DA REUNI√ÉO para o CRM e finalizar atendimento\",\n        \"instructions\": \"Nunca pule esta etapa. Ap√≥s enviar o link da reuni√£o para o cliente, use a tool 'ENVIAR_CRM' para salvar o resumo do cliente E link da reuni√£o no CRM. Ap√≥s isso, use a tool 'finalizar_atendimento'\",\n      }\n    ]\n  }\n\n  \n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.7,"position":[3560,320],"id":"da632be6-5042-4049-a80b-a83a364994bf","name":"AI Agent"},{"parameters":{"operation":"delete","key":"LIA_556285372793_DEAL_ID"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1600,-60],"id":"6677289f-ee3d-4a3c-b213-602fd3e5be0f","name":"Redis1","credentials":{"redis":{"id":"CmFcWR0TAFesyTem","name":"Veridian Redis account"}}},{"parameters":{"mode":"delete","deleteMode":"all"},"type":"@n8n/n8n-nodes-langchain.memoryManager","typeVersion":1.1,"position":[600,-240],"id":"20b8d905-cccb-4d1e-9042-97a5ac38ce9c","name":"Chat Memory Manager"},{"parameters":{"assignments":{"assignments":[{"id":"dacc51da-1873-4c4b-a188-954c6c1620ab","name":"key","value":"={{ $json.body.data.key.remoteJid }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[380,-240],"id":"80c8d2b9-115e-45da-b926-a34087613d2c","name":"Edit Fields6"},{"parameters":{"method":"POST","url":"={{ $('normalizacao').item.json.main.interno.serverUrl }}/message/sendText/{{ $('normalizacao').item.json.main.interno.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $('Webhook1').item.json.body.apikey }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"number\": \"{{ $('Webhook1').item.json.body.data.key.remoteJid.split('@')[0]}}\",\n    \"delay\": 1000,\n    \"text\": \"Seu hist√≥rico de conversa com a IA foi limpo por completo!\"\n}","options":{}},"id":"76d2dab9-a87a-4ba1-8f6d-6c0530bb68e7","name":"Responde texto2","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1560,-240]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"851e7a59-461a-4aab-9745-ccd6ac046590","leftValue":"={{ $('Webhook1').item.json.body.data.message.conversation }}","rightValue":"!excluir","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[140,560],"id":"1e5e5cf0-72e0-4573-9cb0-076625e38f2c","name":"Verifica comando excluir"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('crm').item.json.identifier }}_MEMORY","contextWindowLength":40},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.4,"position":[480,-40],"id":"2360b7b1-4542-4fec-8cf9-d024cd5a2a25","name":"Redis Chat Memory1","disabled":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.intervencao_humana }}","rightValue":"habilitado","operator":{"type":"string","operation":"equals"},"id":"2341e444-e91f-4895-aea5-d7274f3acf1f"}],"combinator":"and"},"renameOutput":true,"outputKey":"Block_IA"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d645d8d0-15e9-4202-a43e-abbbce06bf58","leftValue":"={{ $('normalizacao').item.json.main.interno.fromMe }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"Block_IA"}]},"options":{"fallbackOutput":"extra","renameFallbackOutput":"Prosseguir"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-440,540],"id":"985a5721-0cfb-491a-afee-b0c47c1c6edf","name":"Switch3"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-140,180],"id":"1300048a-76e0-4c2e-b86f-8f0803910e39","name":"No Operation, do nothing1"},{"parameters":{"workflowId":{"__rl":true,"value":"7Kz4oxnZwyqTcvWi","mode":"id"},"workflowInputs":{"mappingMode":"defineBelow","value":{"IDENTIFIER":"={{ $('crm').item.json.identifier }}"},"matchingColumns":["remoteJid"],"schema":[{"id":"IDENTIFIER","displayName":"IDENTIFIER","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-140,340],"id":"b7325428-6f6f-4f3d-aac4-0d52881f7cee","name":"Execute Workflow"},{"parameters":{"operation":"get","propertyName":"intervencao_humana","key":"={{ $json.identifier }}_BLOCK","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-680,420],"id":"9dfb5372-1c39-43c8-b1b4-4a8718d635af","name":"Redis","credentials":{"redis":{"id":"CmFcWR0TAFesyTem","name":"Veridian Redis account"}}},{"parameters":{"httpMethod":"POST","path":"f658438f-ad8e-45d7-96dd-274d8e1c8b71","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1360,420],"id":"e1561f3d-436b-4dfc-83ab-812e354e8146","name":"Webhook1","webhookId":"f658438f-ad8e-45d7-96dd-274d8e1c8b71"},{"parameters":{"method":"POST","url":"={{ $('normalizacao').item.json.main.interno.serverUrl }}/message/sendText/{{ $('normalizacao').item.json.main.interno.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $('normalizacao').item.json.main.interno.apiKey }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $('concat').item.json.main.data.lead.remoteJid }}"},{"name":"text","value":"={{ $json.mensagem }}"},{"name":"delay","value":"={{ 4852 }}"}]},"options":{}},"id":"c5e04388-730f-4aa0-9654-226a592bf250","name":"Responde texto","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5460,500]},{"parameters":{"assignments":{"assignments":[{"id":"3349dad2-28a3-41d8-a5de-c2f72d511327","name":"identifier","value":"=OLIVIA_{{ $json.main.lead.remoteJid.slice(0,12) }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-940,420],"id":"537bd729-dc48-43be-838a-83f62bee294d","name":"crm"},{"parameters":{"operation":"delete","key":"={{ $('crm').item.json.identifier }}_DEAL_ID"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1000,-240],"id":"fa2db364-0081-4545-a275-d51bb80f58df","name":"Redis4","credentials":{"redis":{"id":"CmFcWR0TAFesyTem","name":"Veridian Redis account"}}},{"parameters":{"operation":"delete","key":"={{ $('crm').item.json.identifier }}_NAME"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1220,-240],"id":"9f96d754-4701-41fc-a47d-7e5da2df9f49","name":"Redis5","credentials":{"redis":{"id":"CmFcWR0TAFesyTem","name":"Veridian Redis account"}}},{"parameters":{"operation":"delete","key":"LIA_556285372793_MESSAGE"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1420,-60],"id":"f85d27f7-0da6-4e3b-b534-29b62357276d","name":"Redis6","credentials":{"redis":{"id":"CmFcWR0TAFesyTem","name":"Veridian Redis account"}}},{"parameters":{"assignments":{"assignments":[{"id":"3b27fd5d-3fd5-40a8-8bb0-d1d076e7b4cc","name":"content","value":"={{ $json.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1360,700],"id":"7bc777c8-11d0-44e6-a722-b52f8cebfc6f","name":"concat_audio"},{"parameters":{"resource":"audio","operation":"transcribe","binaryPropertyName":"BinaryAudio","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[1160,700],"id":"a1904f20-3b4d-489e-8745-85c2b5dd9f31","name":"OpenAI","credentials":{"openAiApi":{"id":"v9XOgiBCwDIHSobe","name":"OpenAi account"}}},{"parameters":{"operation":"toBinary","sourceProperty":"base64","binaryPropertyName":"BinaryAudio","options":{"mimeType":"={{ $json.mimetype }}"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[980,700],"id":"a8d3db1c-7380-426d-9fc0-cb28c7ca0a3e","name":"Convert to File"},{"parameters":{"method":"POST","url":"={{ $('normalizacao').item.json.main.interno.serverUrl }}/chat/getBase64FromMediaMessage/{{ $('normalizacao').item.json.main.interno.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $('normalizacao').item.json.main.interno.apiKey }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"message\": {\n    \"key\": {\n      \"id\": \"{{ $('normalizacao').item.json.main.interno.messageId }}\"\n    }\n  }\n} ","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[800,700],"id":"8afb8bc5-1324-479f-919b-1c65771c6084","name":"HTTP Request"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Webhook1').item.json.body.data.key.remoteJid.slice(0,12) }}","tableName":"=olivia_memory","contextWindowLength":30},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[3380,620],"id":"753ca3b8-5a53-4caf-a2df-308149b9a1cc","name":"Postgres Chat Memory","credentials":{"postgres":{"id":"uPYyJq0BaOxFlMb1","name":"Postgres account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('normalizacao').item.json.main.lead.remoteJid.slice(0,12) }}","contextWindowLength":100},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[680,-40],"id":"ac20c563-3214-4640-af18-53c027583289","name":"Postgres Chat Memory1","credentials":{"postgres":{"id":"uPYyJq0BaOxFlMb1","name":"Postgres account"}}},{"parameters":{"content":"## Payload\n","height":500,"width":660,"color":7},"type":"n8n-nodes-base.stickyNote","position":[-1440,220],"typeVersion":1,"id":"16f38daf-2238-49fc-bb26-6fb30da92a42","name":"Sticky Note"},{"parameters":{"content":"## Check block\n","height":580,"width":820,"color":7},"type":"n8n-nodes-base.stickyNote","position":[-720,140],"typeVersion":1,"id":"fadc5aa8-cb64-4897-95af-a76a154da358","name":"Sticky Note1"},{"parameters":{"content":"## Debug tools\n- Comando !excluir\n","height":480,"width":1520,"color":7},"type":"n8n-nodes-base.stickyNote","position":[300,-380],"typeVersion":1,"id":"f44d39b6-f5f0-4cf8-aeec-a79d614feb27","name":"Sticky Note3"},{"parameters":{"content":"## Tratamento de tipos de dados:\n- mensagem de texto / √°udio","height":660,"width":1400,"color":7},"type":"n8n-nodes-base.stickyNote","position":[380,240],"typeVersion":1,"id":"e8e2b83d-f5d1-4d09-b237-216ad8a2057f","name":"Sticky Note4"},{"parameters":{"content":"## Debounce / buffer de mensagens ","height":660,"width":1080,"color":7},"type":"n8n-nodes-base.stickyNote","position":[1820,240],"typeVersion":1,"id":"809cc913-eb8f-411f-a88b-f7f4218e59a7","name":"Sticky Note5"},{"parameters":{"content":"## AI agent","height":680,"width":1320,"color":7},"type":"n8n-nodes-base.stickyNote","position":[3000,260],"typeVersion":1,"id":"ab4a3e6f-01cb-477f-984e-130ad7a39a08","name":"Sticky Note6"},{"parameters":{"content":"## Envio de mensagens em chunks","height":680,"width":1320,"color":7},"type":"n8n-nodes-base.stickyNote","position":[4380,260],"typeVersion":1,"id":"99419ac7-3e65-4096-b720-ac68d5b16beb","name":"Sticky Note7"},{"parameters":{"modelName":"models/gemini-2.0-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[3220,620],"id":"e75bf360-b983-43d1-a812-eed088283d9a","name":"Google Gemini Chat Model1","credentials":{"googlePalmApi":{"id":"3s47YUdlE4NVNVHy","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"jsCode":"// Entrada: um √∫nico item com o campo \"texto\"\nconst texto = $input.first().json.output;\n\n// Quebra o texto em partes, sempre que encontrar uma linha n√£o vazia\nconst partes = texto.split('\\n').map(p => p.trim()).filter(p => p);\n\n// Monta o array de mensagens\nconst mensagens = partes.map(parte => ({ mensagem: parte }));\n\n// Retorna em formato que o n8n espera (array de objetos)\nreturn [\n  {\n    json: {\n      mensagens\n    }\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4000,480],"id":"f72b5c0a-3b79-4b88-95db-58c78cf534bd","name":"Code"},{"parameters":{"description":"Chame essa tool para buscar informa√ß√µes dos produtos, como fotos, descri√ß√£o e pre√ßo.","workflowId":{"__rl":true,"value":"kcMNjziL6W4dnH81","mode":"list","cachedResultName":"VER_CATALOGO"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[3580,640],"id":"2d2e8fdf-94e2-4ba7-82e9-dda1cd4f0c87","name":"ver_catalogo"}],"connections":{"Loop Over Items":{"main":[[],[{"node":"Wait1","type":"main","index":0}]]},"Wait1":{"main":[[{"node":"Responde texto","type":"main","index":0}]]},"Split Out1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"normalizacao":{"main":[[{"node":"crm","type":"main","index":0}]]},"Switch":{"main":[[{"node":"concat_text","type":"main","index":0}],[{"node":"HTTP Request","type":"main","index":0}]]},"concat_text":{"main":[[{"node":"concat","type":"main","index":0}]]},"armazena_messagem":{"main":[[{"node":"obter_mensages_buffer","type":"main","index":0}]]},"obter_mensages_buffer":{"main":[[{"node":"Switch1","type":"main","index":0}]]},"Switch1":{"main":[[],[{"node":"Redis3","type":"main","index":0}],[{"node":"Wait2","type":"main","index":0}]]},"concat":{"main":[[{"node":"armazena_messagem","type":"main","index":0}]]},"Wait2":{"main":[[{"node":"obter_mensages_buffer","type":"main","index":0}]]},"Redis3":{"main":[[{"node":"concatena_messages","type":"main","index":0}]]},"concatena_messages":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"AI Agent":{"main":[[{"node":"Code","type":"main","index":0}]]},"Chat Memory Manager":{"main":[[{"node":"Redis4","type":"main","index":0}]]},"Edit Fields6":{"main":[[{"node":"Chat Memory Manager","type":"main","index":0}]]},"Verifica comando excluir":{"main":[[{"node":"Edit Fields6","type":"main","index":0}],[{"node":"Switch","type":"main","index":0}]]},"Switch3":{"main":[[{"node":"No Operation, do nothing1","type":"main","index":0}],[{"node":"Execute Workflow","type":"main","index":0}],[{"node":"Verifica comando excluir","type":"main","index":0}]]},"Redis":{"main":[[{"node":"Switch3","type":"main","index":0}]]},"Webhook1":{"main":[[{"node":"normalizacao","type":"main","index":0}]]},"Responde texto":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"crm":{"main":[[{"node":"Redis","type":"main","index":0}]]},"Redis4":{"main":[[{"node":"Redis5","type":"main","index":0}]]},"Redis5":{"main":[[{"node":"Responde texto2","type":"main","index":0}]]},"concat_audio":{"main":[[{"node":"concat","type":"main","index":0}]]},"OpenAI":{"main":[[{"node":"concat_audio","type":"main","index":0}]]},"Convert to File":{"main":[[{"node":"OpenAI","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Convert to File","type":"main","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"Postgres Chat Memory1":{"ai_memory":[[{"node":"Chat Memory Manager","type":"ai_memory","index":0}]]},"Redis6":{"main":[[{"node":"Redis1","type":"main","index":0}]]},"Google Gemini Chat Model1":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Code":{"main":[[{"node":"Split Out1","type":"main","index":0}]]},"ver_catalogo":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"Webhook1":[{"json":{"headers":{"host":"webhook.vps.veridianbr.com","user-agent":"axios/1.7.9","content-length":"874","accept-encoding":"gzip, compress, deflate, br","content-type":"application/json","x-forwarded-for":"172.18.0.1","x-forwarded-host":"webhook.vps.veridianbr.com","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"e983dcdea834","x-real-ip":"172.18.0.1"},"params":{},"query":{},"body":{"event":"messages.upsert","instance":"veridian","data":{"key":{"remoteJid":"556285372793@s.whatsapp.net","fromMe":false,"id":"3A686DEFE6784E4293CB"},"pushName":"Lucas Gontijo","status":"DELIVERY_ACK","message":{"conversation":"oi","messageContextInfo":{"deviceListMetadata":{"senderKeyHash":"PikIsnKOcSvDmw==","senderTimestamp":"1749590261","recipientKeyHash":"VMWJmAHgwelD/w==","recipientTimestamp":"1749178418"},"deviceListMetadataVersion":2,"messageSecret":"BkAQKXMk7Iwwc6DdQgcrGXv8W3SY/FnI7i5Vkc/lB/s="}},"messageType":"conversation","messageTimestamp":1749776617,"instanceId":"82733143-4211-4213-b554-05d76afe05c3","source":"ios"},"destination":"https://webhook.vps.veridianbr.com/webhook/vivian","date_time":"2025-06-12T22:03:37.661Z","sender":"556298987033@s.whatsapp.net","server_url":"https://evo.vps.veridianbr.com","apikey":"5AF71EC43E6F-467C-96CE-4EA5A097FE5F"},"webhookUrl":"https://webhook.vps.veridianbr.com/webhook/vivian","executionMode":"production"}}]},"versionId":"99745085-88ee-40fb-98c2-b1667761ac89","triggerCount":1,"tags":[{"createdAt":"2025-06-13T18:40:07.620Z","updatedAt":"2025-06-13T18:40:07.620Z","id":"I8g40OOJRBD0JwRy","name":"OLIVIA"}],"repo":{"owner":"veridianbr","name":"backup","path":"workflows/"}}